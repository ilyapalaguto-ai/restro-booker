# EPIC: Unified Auth & Role-Based Booking Platform
Key: EPIC-1001  
JIRA: https://ilyapalaguto.atlassian.net/browse/EPIC-1001  
Repo: ./epics/EPIC-1001.md

## Контекст
Нужно обеспечить безопасную мульти-ролевую платформу для ресторанов: админ управляет экосистемой, менеджер — своим рестораном, клиент — своими бронированиями. Базовая реализация (регистрация, логин, JWT, проверки ролей в `server/routes.ts`) уже присутствует, но нужна доработка до прод-готовности (refresh токены, унификация ошибок, валидация пересечений бронирований, улучшенные UI хуки).

## Цель
Дать сквозной поток: аутентификация → авторизация → операции с ресторанами, столами, клиентами и бронированиями → аналитика → админ управление пользователями.

## In Scope
- JWT + refresh
- Роли: admin / restaurant_manager / customer
- Ограничение доступа к ресурсам
- CRUD бронирований (пересечения времени)
- Статистика ресторана (дневные метрики, % загрузки)
- Улучшенный UX форм логина/регистрации
- Унификация ошибок (единый формат)
- Мини-аудит (логирование auth и бронирований)

## Out of Scope
- Платежи
- Email/SMS уведомления
- SSO (OAuth)
- Мульти-тенант на уровне отдельных схем БД

## Бизнес-ценность
- Быстрый онбординг ресторанов
- Повышение доверия клиентов
- Минимизация утечек и злоупотреблений

## KPI / Success Criteria
- Регистрация < 15 сек
- 401/403 < 2% всех запросов (при нормальной нагрузке)
- 0 критических уязвимостей статического анализа
- Создание брони < 3 сек (end-to-end)

## Mapping User Stories
| Story | Кратко |
|-------|--------|
| USER-STORY-1001 | Регистрация |
| USER-STORY-1002 | Логин |
| USER-STORY-1003 | Role-based доступ |
| USER-STORY-1004 | Управление ресторанами |
| USER-STORY-1005 | Управление столами |
| USER-STORY-1006 | Создание брони |
| USER-STORY-1007 | Просмотр своих броней |
| USER-STORY-1008 | Статистика ресторана |
| USER-STORY-1009 | Управление пользователями |
| USER-STORY-1010 | Унифицированные ошибки |
| USER-STORY-1011 | Refresh токены |
| USER-STORY-1012 | Авто-привязка customer при создании брони |

## Риски
- Отсутствие refresh → частые релогины
- Неконсистентный формат ошибок → сложный UI
- Отсутствие проверки пересечений → двойные брони

## Зависимости
- `server/routes.ts`, `server/storage.ts`
- `shared/schema.ts`
- `client/src/hooks/use-auth.tsx`, `use-bookings.tsx`
- `client/src/pages/login.tsx`, `register.tsx`

## High-Level Plan
1. Централизация авторизации (middleware + модуль).
2. Refresh токены.
3. Пересечения бронирований.
4. Аналитика расширена (occupancy %).
5. Унификация ошибок.
6. Улучшение React Query хуков.
7. Мини-аудит логов.

## Definition of Done
- Все stories покрыты задачами.
- Все задачи merged в main.
- Мини smoke-сценарий выполняется успешно.
- Обновлена `.jira` и `README` (при необходимости).

## Success Validation
- Ручное тестирование CRUD + авторизация.
- Лог консоли без неформатированных `console.log`.

## Связанные Stories
USER-STORY-1001 … USER-STORY-1012
